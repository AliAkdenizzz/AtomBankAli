<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Atom Bank - Smart Assistant</title>
    <link href="https://fonts.googleapis.com" rel="preconnect"/>
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <!-- Theme System CSS (must load before dashboard.css) -->
    <link rel="stylesheet" href="./theme.css">
    <link rel="stylesheet" href="./dashboard.css">
    <link rel="stylesheet" href="./smartassistant.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        "atom-bg": "#e5e8f0",
                        "atom-text-black": "#020617",
                        "atom-text-grey": "#a1a3af",
                        "atom-text-dark-grey": "#4b5563",
                        "atom-primary": "#6366f1",
                        "atom-secondary": "#22c55e",
                        "atom-blue": "#38bdf8",
                        "atom-circle-1": "#ffd8f0",
                        "atom-circle-2": "#c7bfff",
                    },
                    fontFamily: {
                        "sans": ["Poppins", "-apple-system", "BlinkMacSystemFont", "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Cantarell", "Fira Sans", "Droid Sans", "Helvetica Neue", "sans-serif"]
                    },
                    boxShadow: {
                        "soft": "0 18px 40px rgba(148, 163, 184, 0.35)",
                        "glow": "0 10px 30px rgba(79, 70, 229, 0.5)",
                        "message": "0 2px 5px rgba(0,0,0,0.05)"
                    },
                    borderRadius: {"DEFAULT": "1rem", "lg": "1.5rem", "xl": "2rem", "2xl": "2.5rem", "full": "9999px"},
                },
            },
        }
    </script>
    <style>
        /* Extra styles for chatbot */
        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 16px 24px;
        }
        .typing-indicator span {
            width: 8px;
            height: 8px;
            background: #a1a3af;
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
            30% { transform: translateY(-8px); opacity: 1; }
        }

        .suggestion-btn {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border: 1px solid #e2e8f0;
            padding: 10px 18px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
            color: #475569;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }
        .suggestion-btn:hover {
            background: linear-gradient(135deg, #6366f1, #38bdf8);
            color: white;
            border-color: transparent;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .quick-action-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            background: white;
            border: 1px solid #e2e8f0;
            padding: 12px 16px;
            border-radius: 16px;
            font-size: 13px;
            font-weight: 500;
            color: #334155;
            cursor: pointer;
            transition: all 0.2s;
        }
        .quick-action-btn:hover {
            border-color: #6366f1;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.15);
        }
        .quick-action-btn .material-symbols-outlined {
            font-size: 20px;
            color: #6366f1;
        }

        .confirmation-box {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 1px solid #f59e0b;
            border-radius: 16px;
            padding: 16px;
            margin-top: 12px;
        }
        .confirmation-box .confirm-buttons {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }
        .confirmation-box .btn-confirm {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .confirmation-box .btn-confirm:hover {
            transform: scale(1.05);
        }
        .confirmation-box .btn-cancel {
            background: #f1f5f9;
            color: #64748b;
            border: 1px solid #e2e8f0;
            padding: 8px 20px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .confirmation-box .btn-cancel:hover {
            background: #e2e8f0;
        }

        .data-card {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 12px 16px;
            margin-top: 12px;
        }
        .data-card-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e2e8f0;
        }
        .data-card-item:last-child {
            border-bottom: none;
        }
        .data-card-label {
            color: #64748b;
            font-size: 13px;
        }
        .data-card-value {
            color: #1e293b;
            font-weight: 600;
            font-size: 13px;
        }

        .message-content {
            white-space: pre-wrap;
        }
        .message-content strong {
            font-weight: 600;
        }

        /* Dark mode adjustments */
        .dark .suggestion-btn {
            background: linear-gradient(135deg, #334155 0%, #1e293b 100%);
            border-color: #475569;
            color: #cbd5e1;
        }
        .dark .suggestion-btn:hover {
            background: linear-gradient(135deg, #6366f1, #38bdf8);
            color: white;
        }
        .dark .quick-action-btn {
            background: #1e293b;
            border-color: #475569;
            color: #e2e8f0;
        }
        .dark .quick-action-btn:hover {
            border-color: #6366f1;
        }
        .dark .data-card {
            background: #334155;
            border-color: #475569;
        }
        .dark .data-card-item {
            border-color: #475569;
        }
        .dark .data-card-label {
            color: #94a3b8;
        }
        .dark .data-card-value {
            color: #f1f5f9;
        }
        .dark .confirmation-box {
            background: linear-gradient(135deg, #78350f 0%, #92400e 100%);
            border-color: #b45309;
        }
        .dark .confirmation-box .text-amber-800 {
            color: #fef3c7 !important;
        }
        .dark .confirmation-box .btn-cancel {
            background: #1e293b;
            border-color: #475569;
            color: #cbd5e1;
        }
        .dark .typing-indicator span {
            background: #94a3b8;
        }
        .dark #chatContainer {
            background: rgba(30, 41, 59, 0.3) !important;
        }
        .dark .bg-green-50 {
            background: rgba(34, 197, 94, 0.2) !important;
        }
        .dark .bg-indigo-50 {
            background: rgba(99, 102, 241, 0.2) !important;
        }
        .dark .bg-indigo-50:hover {
            background: rgba(99, 102, 241, 0.3) !important;
        }
    </style>
<script src="./authGuard.js"></script>
</head>
<body class="light">

    <div class="bg-circle-1"></div>
    <div class="bg-circle-2"></div>

    <div class="container">

        <!-- Sidebar -->
        <nav class="sidebar" id="sidebar">
          <button id="btn_close">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16">
              <path fill="none" d="M0 0h24v24H0z" />
              <path d="M12 10.586l4.95-4.95 1.414 1.414-4.95 4.95 4.95 4.95-1.414 1.414-4.95-4.95-4.95 4.95-1.414-1.414 4.95-4.95-4.95-4.95L7.05 5.636z" />
            </svg>
          </button>

          <div class="logo">
            <img src="./images/logo.png" alt="Atom Bank Logo">
            <span>Atom Bank</span>
          </div>

          <div class="nav_links">
            <a href="./dashboard.html" class="nav_link" aria-label="overview">
              <span class="material-symbols-outlined">grid_view</span>
              <div class="nav_link_text" data-i18n="overview">Overview</div>
            </a>

            <a href="./accounthistory.html" class="nav_link" aria-label="account-history">
              <span class="material-symbols-outlined">history</span>
              <div class="nav_link_text" data-i18n="accounts">Account History</div>
            </a>

            <a href="./fundtransfer.html" class="nav_link" aria-label="fund-transfer">
              <span class="material-symbols-outlined">swap_horiz</span>
              <div class="nav_link_text" data-i18n="fundTransfer">Fund Transfer</div>
            </a>

            <a href="./billpayments.html" class="nav_link" aria-label="bill-payment">
              <span class="material-symbols-outlined">receipt_long</span>
              <div class="nav_link_text" data-i18n="billPayment">Bill Payment</div>
            </a>

            <a href="./currencyexchange.html" class="nav_link" aria-label="currency-exchange">
              <span class="material-symbols-outlined">currency_exchange</span>
              <div class="nav_link_text" data-i18n="currencyExchange">Currency Exchange</div>
            </a>

            <a href="./smartassistant.html" class="nav_link active" aria-label="smart-assistant">
              <span class="material-symbols-outlined icon-fill">smart_toy</span>
              <div class="nav_link_text" data-i18n="smartAssistantSupport">Smart Assistant Support</div>
            </a>
            
            <!-- LOGOUT BUTTON -->
            <a href="#" class="nav_link" id="navLogout" style="margin-top: 20px;">
              <span class="material-symbols-outlined">logout</span>
              <div class="nav_link_text">Log Out</div>
            </a>
          </div>

          <div class="life_cover_offer">
            <img src="./images/women.svg" alt="" />
          <div class="life_cover_text">
            <p class="title" data-i18n="welcomeToAtomBank">Welcome to Atom Bank</p>
            <p class="desc" data-i18n="manageBalance">Manage your balance, transfers and cards in one aurora-style dashboard.</p>
          </div>
          <a href="#" aria-label="open-account" data-i18n="openNewAccount">Open new account</a>
          </div>

          <div class="profile" id="profileCard">
            <div class="img_with_name">
              <img src="./images/profile.jpg" id="sidebarProfileImg" alt="User">
              <div class="profile_text">
                <p class="name" id="profileName">User</p>
              </div>
            </div>
            <svg id="logoutIcon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" style="cursor: pointer;">
              <path fill="none" d="M0 0h24v24H0z" />
              <path class="icon" d="M13.172 12l-4.95-4.95 1.414-1.414L16 12l-6.364 6.364-1.414-1.414z" />
            </svg>
          </div>
        </nav>

        <!-- Main Content -->
        <section class="main_content">
            <div class="topbar">
                <button id="menu_btn">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16">
                        <path fill="none" d="M0 0h24v24H0z" />
                        <path d="M3 4h18v2H3V4zm0 7h12v2H3v-2zm0 7h18v2H3v-2z" />
                    </svg>
                </button>
                <div class="topbar_icons">
                </div>
            </div>

        <main class="flex-1 flex flex-col h-full overflow-hidden relative">

            <div class="flex-1 flex flex-col p-6 md:p-8 lg:p-10 overflow-hidden">
                <div class="max-w-6xl mx-auto w-full h-full flex flex-col gap-6">

                    <!-- Header -->
                    <div class="flex justify-between items-center shrink-0">
                        <div>
                            <h2 class="text-4xl font-light text-atom-text-black" data-i18n="smartAssistant">Smart Assistant</h2>
                            <p class="text-sm text-atom-text-dark-grey mt-1" data-i18n="getHelp">Your AI-powered banking assistant</p>
                        </div>
                        <!-- Quick Actions -->
                        <div id="quickActionsContainer" class="hidden md:flex gap-2">
                            <!-- Quick actions loaded dynamically -->
                        </div>
                    </div>

                    <!-- Chat Container -->
                    <div class="flex-1 bg-white rounded-[30px] shadow-soft flex flex-col overflow-hidden relative border border-white z-10">

                        <!-- Chat Header -->
                        <div class="p-6 border-b border-gray-100 flex items-center justify-between bg-white z-20 shadow-sm">
                            <div class="flex items-center gap-4">
                                <div class="relative">
                                    <div class="size-14 rounded-2xl bg-gradient-to-br from-atom-primary to-atom-blue flex items-center justify-center text-white shadow-lg shadow-atom-primary/30">
                                        <span class="material-symbols-outlined icon-fill text-3xl">smart_toy</span>
                                    </div>
                                    <div class="absolute -bottom-1 -right-1 size-4 bg-atom-secondary border-[3px] border-white rounded-full"></div>
                                </div>
                                <div>
                                    <h3 class="font-bold text-atom-text-black text-xl" data-i18n="atomAssistant">Atom Assistant</h3>
                                    <div class="flex items-center gap-1.5 text-xs font-semibold text-atom-secondary bg-green-50 px-2 py-0.5 rounded-full w-fit mt-1">
                                        <span class="relative flex h-1.5 w-1.5">
                                          <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                                          <span class="relative inline-flex rounded-full h-1.5 w-1.5 bg-atom-secondary"></span>
                                        </span>
                                        <span data-i18n="online">Online</span>
                                    </div>
                                </div>
                            </div>
                            <div class="flex items-center gap-2">
                                <button id="helpBtn" class="text-sm font-semibold text-atom-primary bg-indigo-50 hover:bg-indigo-100 px-4 py-2 rounded-xl transition-colors flex items-center gap-2">
                                    <span class="material-symbols-outlined text-lg">help</span>
                                    <span data-i18n="help">Help</span>
                                </button>
                                <button id="clearChatBtn" class="text-sm font-semibold text-atom-text-dark-grey bg-gray-50 hover:bg-gray-100 px-4 py-2 rounded-xl transition-colors" data-i18n="clearChat">
                                    Clear Chat
                                </button>
                            </div>
                        </div>

                        <!-- Messages Area -->
                        <div id="chatContainer" class="flex-1 overflow-y-auto p-8 space-y-6 chat-scroll bg-gray-50/30">
                            <!-- Date Divider -->
                            <div class="flex justify-center mb-6">
                                <span id="chatDate" class="text-xs font-semibold text-atom-text-grey bg-white border border-gray-100 px-4 py-1.5 rounded-full shadow-sm"></span>
                            </div>

                            <!-- Welcome message will be added by JS -->
                        </div>

                        <!-- Suggestions Area -->
                        <div id="suggestionsContainer" class="px-6 py-3 bg-white border-t border-gray-100 overflow-x-auto">
                            <div id="suggestions" class="flex gap-2 flex-wrap">
                                <!-- Suggestions added dynamically -->
                            </div>
                        </div>

                        <!-- Input Area -->
                        <div class="p-6 bg-white border-t border-gray-100 z-20">
                            <div class="relative flex items-center gap-3 max-w-4xl mx-auto">
                                <div class="flex-1 relative">
                                    <input id="chatInput" class="w-full bg-atom-bg border-none focus:ring-2 focus:ring-atom-primary/20 rounded-2xl py-4 pl-6 pr-16 text-atom-text-black placeholder-gray-400 text-sm font-medium transition-all shadow-inner" data-i18n-placeholder="askQuestion" placeholder="Type your message..." />
                                    <button id="sendBtn" class="absolute right-2 top-1/2 -translate-y-1/2 p-2.5 btn-gradient rounded-xl hover:scale-105 transition-all shadow-md flex items-center justify-center group disabled:opacity-50 disabled:cursor-not-allowed">
                                        <span class="material-symbols-outlined icon-fill text-[20px] ml-0.5 group-hover:-translate-y-0.5 group-hover:translate-x-0.5 transition-transform">send</span>
                                    </button>
                                </div>
                            </div>
                            <div class="text-center mt-4">
                                <p class="text-[10px] text-gray-400 font-medium" data-i18n="poweredBy">Atom Assistant - Making your banking easier</p>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </main>
        </section>
    </div>

    <script src="./dataFetcher.js"></script>
    <script src="./translations.js"></script>
    <script src="./main.js"></script>
    <script src="./smartassistantData.js"></script>

<script>
// ================== CHATBOT INTEGRATION ==================

const chatInput = document.getElementById('chatInput');
const sendBtn = document.getElementById('sendBtn');
const chatContainer = document.getElementById('chatContainer');
const suggestionsContainer = document.getElementById('suggestions');
const quickActionsContainer = document.getElementById('quickActionsContainer');
const helpBtn = document.getElementById('helpBtn');
const clearChatBtn = document.getElementById('clearChatBtn');
const chatDate = document.getElementById('chatDate');

// Get current language
function getLang() {
    return localStorage.getItem('atomBankLanguage') || 'en';
}

// Translation helper
function translate(key, fallback) {
    if (typeof window.t === 'function') {
        return window.t(key) || fallback || key;
    }
    return fallback || key;
}

// Set current date based on language
function updateChatDate() {
    const lang = getLang();
    const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
    chatDate.textContent = new Date().toLocaleDateString(lang === 'tr' ? 'tr-TR' : 'en-US', options);
}
updateChatDate();

// State
let isWaitingForResponse = false;
let pendingConfirmation = false;

// Get auth token
function getToken() {
    return localStorage.getItem('atomBankToken') || sessionStorage.getItem('atomBankToken');
}

// Format time based on language
function getCurrentTime() {
    const lang = getLang();
    return new Date().toLocaleTimeString(lang === 'tr' ? 'tr-TR' : 'en-US', { hour: '2-digit', minute: '2-digit' });
}

// Add message to chat
function addMessage(content, isUser, data = null, requiresConfirmation = false) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `flex gap-4 max-w-3xl ${isUser ? 'ml-auto flex-row-reverse' : ''}`;

    const avatarHtml = isUser
        ? `<div class="size-10 rounded-full bg-gradient-to-br from-atom-primary to-atom-blue flex-shrink-0 flex items-center justify-center text-white mt-1 shadow-md">
            <span class="material-symbols-outlined text-lg">person</span>
           </div>`
        : `<div class="size-10 rounded-full bg-atom-primary flex-shrink-0 flex items-center justify-center text-white mt-1 shadow-md shadow-atom-primary/20">
            <span class="material-symbols-outlined icon-fill text-xl">smart_toy</span>
           </div>`;

    const bubbleClass = isUser
        ? 'bg-gradient-to-br from-atom-primary to-atom-blue text-white rounded-[24px] rounded-tr-none shadow-md'
        : 'bg-white text-atom-text-black border border-gray-100 rounded-[24px] rounded-tl-none shadow-message';

    // Format message content (handle markdown-like formatting)
    let formattedContent = content
        .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
        .replace(/\n/g, '<br>')
        .replace(/━+/g, '<hr class="my-2 border-gray-200">')
        .replace(/^- (.+)/gm, '• $1')
        .replace(/^> (.+)/gm, '<span class="text-gray-500 italic">$1</span>');

    let dataHtml = '';
    if (data && !isUser) {
        dataHtml = renderData(data);
    }

    let confirmationHtml = '';
    if (requiresConfirmation && !isUser) {
        pendingConfirmation = true;
        confirmationHtml = `
            <div class="confirmation-box">
                <div class="text-sm font-medium text-amber-800">${translate('confirmAction', 'Waiting for your confirmation')}</div>
                <div class="confirm-buttons">
                    <button class="btn-confirm" onclick="sendConfirmation('Evet')">
                        <span class="flex items-center gap-1">
                            <span class="material-symbols-outlined text-sm">check</span>
                            ${translate('yesConfirm', 'Yes, Confirm')}
                        </span>
                    </button>
                    <button class="btn-cancel" onclick="sendConfirmation('Hayir')">
                        <span class="flex items-center gap-1">
                            <span class="material-symbols-outlined text-sm">close</span>
                            ${translate('noCancel', 'Cancel')}
                        </span>
                    </button>
                </div>
            </div>
        `;
    }

    messageDiv.innerHTML = `
        ${avatarHtml}
        <div class="flex flex-col gap-1.5 ${isUser ? 'items-end' : ''}" style="max-width: 85%;">
            <div class="p-6 ${bubbleClass}">
                <div class="message-content leading-relaxed text-[15px]">${formattedContent}</div>
                ${dataHtml}
                ${confirmationHtml}
            </div>
            <span class="text-[11px] font-medium text-atom-text-grey ${isUser ? 'mr-2' : 'ml-2'}">${getCurrentTime()}</span>
        </div>
    `;

    chatContainer.appendChild(messageDiv);
    chatContainer.scrollTop = chatContainer.scrollHeight;
}

// Render data cards
function renderData(data) {
    if (!data) return '';

    let html = '';

    // Accounts
    if (data.accounts && Array.isArray(data.accounts)) {
        html += '<div class="data-card mt-3">';
        data.accounts.forEach(acc => {
            html += `
                <div class="data-card-item">
                    <span class="data-card-label">${acc.name || acc.accountName}</span>
                    <span class="data-card-value">${acc.balance}</span>
                </div>
            `;
        });
        if (data.totalTRY) {
            html += `
                <div class="data-card-item" style="background: #f0fdf4; margin: 8px -16px -12px; padding: 12px 16px; border-radius: 0 0 12px 12px;">
                    <span class="data-card-label font-semibold">${translate('total', 'Total')} (TRY)</span>
                    <span class="data-card-value text-green-600">${data.totalTRY}</span>
                </div>
            `;
        }
        html += '</div>';
    }

    // Bills
    if (data.bills && Array.isArray(data.bills)) {
        html += '<div class="data-card mt-3">';
        data.bills.forEach(bill => {
            html += `
                <div class="data-card-item">
                    <div>
                        <span class="data-card-label block">${bill.title}</span>
                        ${bill.dueDate ? `<span class="text-xs text-gray-400">${translate('lastPayment', 'Last payment')}: ${bill.dueDate}</span>` : ''}
                    </div>
                    <span class="data-card-value text-red-500">${bill.amount}</span>
                </div>
            `;
        });
        if (data.totalAmount) {
            html += `
                <div class="data-card-item" style="background: #fef2f2; margin: 8px -16px -12px; padding: 12px 16px; border-radius: 0 0 12px 12px;">
                    <span class="data-card-label font-semibold">${translate('total', 'Total')}</span>
                    <span class="data-card-value text-red-600">${data.totalAmount}</span>
                </div>
            `;
        }
        html += '</div>';
    }

    // Goals
    if (data.goals && Array.isArray(data.goals)) {
        html += '<div class="data-card mt-3">';
        data.goals.forEach(goal => {
            const progressPercent = parseFloat(goal.progress) || 0;
            html += `
                <div class="data-card-item flex-col items-start gap-2">
                    <div class="flex justify-between w-full">
                        <span class="data-card-label">${goal.name}</span>
                        <span class="data-card-value">${goal.current} / ${goal.target}</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-gradient-to-r from-atom-primary to-atom-secondary h-2 rounded-full" style="width: ${progressPercent}%"></div>
                    </div>
                    <div class="flex justify-between w-full text-xs">
                        <span class="text-gray-400">${goal.statusText || goal.status}</span>
                        <span class="text-atom-primary font-semibold">${goal.progress}</span>
                    </div>
                </div>
            `;
        });
        html += '</div>';
    }

    // Transactions
    if (data.transactions && Array.isArray(data.transactions)) {
        html += '<div class="data-card mt-3" style="max-height: 300px; overflow-y: auto;">';
        data.transactions.forEach(tx => {
            const isIncome = tx.type.includes('in') || tx.type === 'deposit';
            html += `
                <div class="data-card-item">
                    <div>
                        <span class="data-card-label block">${tx.description || tx.type}</span>
                        <span class="text-xs text-gray-400">${tx.date} - ${tx.account}</span>
                    </div>
                    <span class="data-card-value ${isIncome ? 'text-green-600' : 'text-red-500'}">${isIncome ? '+' : '-'}${tx.amount}</span>
                </div>
            `;
        });
        html += '</div>';
    }

    // Spending summary
    if (data.totalIncome !== undefined || data.totalSpending !== undefined) {
        html += '<div class="data-card mt-3">';
        if (data.totalIncome) {
            html += `<div class="data-card-item"><span class="data-card-label">${translate('income', 'Income')}</span><span class="data-card-value text-green-600">+${data.totalIncome}</span></div>`;
        }
        if (data.totalSpending) {
            html += `<div class="data-card-item"><span class="data-card-label">${translate('expense', 'Expense')}</span><span class="data-card-value text-red-500">-${data.totalSpending}</span></div>`;
        }
        if (data.net) {
            const isPositive = !data.net.startsWith('-');
            html += `<div class="data-card-item"><span class="data-card-label font-semibold">${translate('net', 'Net')}</span><span class="data-card-value ${isPositive ? 'text-green-600' : 'text-red-500'}">${data.net}</span></div>`;
        }
        html += '</div>';
    }

    // Category breakdown for spending analysis
    if (data.categoryBreakdown && Array.isArray(data.categoryBreakdown) && data.categoryBreakdown.length > 0) {
        html += '<div class="data-card mt-3">';
        html += `<div class="text-xs font-semibold text-gray-500 mb-2">${translate('categoryBreakdown', 'Kategori Dağılımı')}</div>`;
        data.categoryBreakdown.forEach(cat => {
            const percentage = parseFloat(cat.percentage) || 0;
            const isHigh = percentage >= 80;
            html += `
                <div class="data-card-item flex-col items-start gap-2">
                    <div class="flex justify-between w-full">
                        <span class="data-card-label ${isHigh ? 'text-orange-600 font-semibold' : ''}">${cat.category} ${isHigh ? '⚠️' : ''}</span>
                        <span class="data-card-value">${cat.amount} (${cat.percentage})</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="h-2 rounded-full ${isHigh ? 'bg-orange-500' : 'bg-gradient-to-r from-atom-primary to-atom-secondary'}" style="width: ${Math.min(percentage, 100)}%"></div>
                    </div>
                </div>
            `;
        });
        html += '</div>';
    }

    // Quick stats
    if (data.quickStats) {
        html += '<div class="data-card mt-3">';
        html += `<div class="data-card-item"><span class="data-card-label">${translate('totalBalance', 'Total Balance')}</span><span class="data-card-value">${data.quickStats.totalBalance}</span></div>`;
        html += `<div class="data-card-item"><span class="data-card-label">${translate('accountCount', 'Account Count')}</span><span class="data-card-value">${data.quickStats.accountCount}</span></div>`;
        html += `<div class="data-card-item"><span class="data-card-label">${translate('pendingBills', 'Pending Bills')}</span><span class="data-card-value ${data.quickStats.pendingBills > 0 ? 'text-red-500' : ''}">${data.quickStats.pendingBills}</span></div>`;
        html += '</div>';
    }

    // Saved recipients
    if (data.savedRecipients && Array.isArray(data.savedRecipients) && data.savedRecipients.length > 0) {
        html += '<div class="data-card mt-3">';
        html += `<div class="text-xs font-semibold text-gray-500 mb-2">${translate('savedRecipients', 'Saved Recipients')}</div>`;
        data.savedRecipients.forEach(r => {
            if (typeof r === 'string') {
                html += `<div class="data-card-item"><span class="data-card-label">${r}</span></div>`;
            } else {
                html += `<div class="data-card-item"><span class="data-card-label">${r.name}</span><span class="text-xs text-gray-400">${r.iban || ''}</span></div>`;
            }
        });
        html += '</div>';
    }

    // Created account info
    if (data.account && data.account.iban) {
        html += '<div class="data-card mt-3">';
        html += `<div class="data-card-item"><span class="data-card-label">${translate('accountName', 'Account Name')}</span><span class="data-card-value">${data.account.name}</span></div>`;
        html += `<div class="data-card-item"><span class="data-card-label">IBAN</span><span class="data-card-value text-xs">${data.account.iban}</span></div>`;
        html += `<div class="data-card-item"><span class="data-card-label">${translate('accountType', 'Type')}</span><span class="data-card-value">${data.account.type}</span></div>`;
        html += `<div class="data-card-item"><span class="data-card-label">${translate('currency', 'Currency')}</span><span class="data-card-value">${data.account.currency}</span></div>`;
        html += '</div>';
    }

    return html;
}

// Update suggestions
function updateSuggestions(suggestions) {
    suggestionsContainer.innerHTML = '';
    const lang = getLang();

    if (!suggestions || suggestions.length === 0) {
        suggestions = lang === 'tr'
            ? ['Bakiyem', 'Faturalarim', 'Hedeflerim', 'Yardim']
            : ['Balance', 'Bills', 'Goals', 'Help'];
    }

    suggestions.forEach(suggestion => {
        const btn = document.createElement('button');
        btn.className = 'suggestion-btn';
        btn.textContent = suggestion;
        btn.onclick = () => sendMessage(suggestion);
        suggestionsContainer.appendChild(btn);
    });
}

// Show typing indicator
function showTyping() {
    const typingDiv = document.createElement('div');
    typingDiv.id = 'typingIndicator';
    typingDiv.className = 'flex gap-4 max-w-3xl';
    typingDiv.innerHTML = `
        <div class="size-10 rounded-full bg-atom-primary flex-shrink-0 flex items-center justify-center text-white mt-1 shadow-md shadow-atom-primary/20">
            <span class="material-symbols-outlined icon-fill text-xl">smart_toy</span>
        </div>
        <div class="bg-white border border-gray-100 rounded-[24px] rounded-tl-none shadow-message">
            <div class="typing-indicator">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
    `;
    chatContainer.appendChild(typingDiv);
    chatContainer.scrollTop = chatContainer.scrollHeight;
}

// Hide typing indicator
function hideTyping() {
    const typing = document.getElementById('typingIndicator');
    if (typing) typing.remove();
}

// Send message to API
async function sendMessage(text) {
    if (!text || isWaitingForResponse) return;

    const token = getToken();
    if (!token) {
        addMessage(translate('sessionExpired', 'Session expired. Please login again.'), false);
        return;
    }

    // Add user message
    addMessage(text, true);
    chatInput.value = '';

    // Show typing
    isWaitingForResponse = true;
    sendBtn.disabled = true;
    showTyping();

    try {
        const response = await fetch('/api/chatbot/chat', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + token
            },
            body: JSON.stringify({ message: text })
        });

        const result = await response.json();
        hideTyping();

        if (result.success) {
            addMessage(
                result.message,
                false,
                result.data,
                result.requiresConfirmation
            );
            updateSuggestions(result.suggestions);
        } else {
            addMessage(result.message || translate('errorOccurred', 'An error occurred. Please try again.'), false);
        }
    } catch (error) {
        hideTyping();
        console.error('Chat error:', error);
        addMessage(translate('connectionError', 'Connection error. Please try again.'), false);
    } finally {
        isWaitingForResponse = false;
        sendBtn.disabled = false;
    }
}

// Send confirmation
function sendConfirmation(response) {
    pendingConfirmation = false;
    sendMessage(response);
}

// Load quick actions
async function loadQuickActions() {
    const token = getToken();
    if (!token) return;

    try {
        const response = await fetch('/api/chatbot/quick-actions', {
            headers: { 'Authorization': 'Bearer ' + token }
        });
        const result = await response.json();

        if (result.success && result.actions) {
            quickActionsContainer.innerHTML = '';
            result.actions.forEach(action => {
                const iconMap = {
                    'receipt': 'receipt_long',
                    'wallet': 'account_balance_wallet',
                    'send': 'send',
                    'plus': 'add_circle'
                };
                const btn = document.createElement('button');
                btn.className = 'quick-action-btn';
                btn.innerHTML = `
                    <span class="material-symbols-outlined">${iconMap[action.icon] || 'star'}</span>
                    ${action.label}
                `;
                btn.onclick = () => {
                    const lang = getLang();
                    const messageMap = {
                        'PAY_BILL': lang === 'tr' ? 'Faturalarim' : 'My bills',
                        'BALANCE': lang === 'tr' ? 'Bakiyem' : 'My balance',
                        'TRANSFER': lang === 'tr' ? 'Para gonder' : 'Send money',
                        'CREATE_ACCOUNT': lang === 'tr' ? 'Yeni hesap ac' : 'Open new account'
                    };
                    sendMessage(messageMap[action.type] || action.label);
                };
                quickActionsContainer.appendChild(btn);
            });
        }
    } catch (error) {
        console.error('Quick actions error:', error);
    }
}

// Show help
async function showHelp() {
    const token = getToken();
    if (!token) return;

    isWaitingForResponse = true;
    showTyping();

    try {
        const response = await fetch('/api/chatbot/help', {
            headers: { 'Authorization': 'Bearer ' + token }
        });
        const result = await response.json();
        hideTyping();

        if (result.success) {
            addMessage(result.message, false, result.data);
            updateSuggestions(result.suggestions);
        }
    } catch (error) {
        hideTyping();
        console.error('Help error:', error);
    } finally {
        isWaitingForResponse = false;
    }
}

// Clear chat
function clearChat() {
    const lang = getLang();
    const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
    const dateStr = new Date().toLocaleDateString(lang === 'tr' ? 'tr-TR' : 'en-US', options);

    // Keep only date divider
    chatContainer.innerHTML = `
        <div class="flex justify-center mb-6">
            <span id="chatDate" class="text-xs font-semibold text-atom-text-grey bg-white border border-gray-100 px-4 py-1.5 rounded-full shadow-sm">${dateStr}</span>
        </div>
    `;

    // Clear session on server
    const token = getToken();
    if (token) {
        fetch('/api/chatbot/session', {
            method: 'DELETE',
            headers: { 'Authorization': 'Bearer ' + token }
        });
    }

    // Send greeting
    const greeting = lang === 'tr' ? 'Merhaba' : 'Hello';
    sendMessage(greeting);
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    // Load quick actions
    loadQuickActions();

    // Initial greeting based on language
    setTimeout(() => {
        const lang = getLang();
        const greeting = lang === 'tr' ? 'Merhaba' : 'Hello';
        sendMessage(greeting);
    }, 500);

    // Update initial suggestions based on language
    const lang = getLang();
    const defaultSuggestions = lang === 'tr'
        ? ['Bakiyem', 'Faturalarim', 'Hedeflerim', 'Yeni hesap ac']
        : ['My balance', 'My bills', 'My goals', 'Open account'];
    updateSuggestions(defaultSuggestions);
});

// Event listeners
sendBtn.addEventListener('click', () => sendMessage(chatInput.value.trim()));

chatInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage(chatInput.value.trim());
    }
});

helpBtn.addEventListener('click', showHelp);
clearChatBtn.addEventListener('click', clearChat);

// Make sendConfirmation globally available
window.sendConfirmation = sendConfirmation;

// Listen for language changes
window.addEventListener('storage', function(e) {
    if (e.key === 'atomBankLanguage') {
        updateChatDate();
        // Update suggestions
        const lang = getLang();
        const defaultSuggestions = lang === 'tr'
            ? ['Bakiyem', 'Faturalarim', 'Hedeflerim', 'Yardim']
            : ['Balance', 'Bills', 'Goals', 'Help'];
        updateSuggestions(defaultSuggestions);
    }
});
</script>
</body>
</html>